%% ============================================================
%% 編輯組合 - 資料流架構圖
%% Edit Combo - Data Flow Architecture Diagram
%% ============================================================
flowchart LR
    %% ============================================================
    %% 使用者介面層
    %% ============================================================
    subgraph UI["使用者介面"]
        direction TB
        CsvDrop[CsvDropZone]
        HtmlDrop[HtmlDropZone]
        EditPage[edit-combo/page.tsx]
        ProductCard[ProductRowCard]
    end

    %% ============================================================
    %% Hooks 層
    %% ============================================================
    subgraph Hooks["Hooks"]
        direction TB
        useCsv[useCsvUpload]
        useFile[useFileUpload]
    end

    CsvDrop --> useCsv
    HtmlDrop --> useFile

    %% ============================================================
    %% 服務層
    %% ============================================================
    subgraph Services["服務層"]
        direction TB
        ProductSvc[product-service]
        ImportSvc[import-service]
        CsvExport[csv-export-service]
        HtmlExport[html-export-service]
        GSheetSvc[google-sheets-service]
    end

    useCsv --> ImportSvc
    useFile --> ImportSvc
    ImportSvc --> ProductSvc
    EditPage --> CsvExport
    EditPage --> HtmlExport
    EditPage --> GSheetSvc

    %% ============================================================
    %% 狀態管理 (核心)
    %% ============================================================
    subgraph Store["Zustand Store"]
        direction TB
        RowsStore[["useRowsStore<br/>(核心狀態中心)"]]
        Rows[(rows)]
        CodeItems[(codeItems)]
        Results[(results)]
        History[(history)]
    end

    RowsStore --- Rows
    RowsStore --- CodeItems
    RowsStore --- Results
    RowsStore --- History

    ImportSvc --> RowsStore
    ProductSvc --> RowsStore
    RowsStore --> EditPage
    RowsStore --> ProductCard

    %% ============================================================
    %% API 路由層
    %% ============================================================
    subgraph API["API Routes"]
        direction TB
        ProductsAPI["/api/products/list"]
        GSheetGetAPI["/api/google-sheets/get"]
        GSheetUpdateAPI["/api/google-sheets/update"]
        AIApi["/api/ai"]
    end

    ProductSvc --> ProductsAPI
    GSheetSvc --> GSheetGetAPI
    GSheetSvc --> GSheetUpdateAPI
    EditPage --> AIApi

    %% ============================================================
    %% 外部服務
    %% ============================================================
    subgraph External["外部服務"]
        direction TB
        MRLiving[(MRLiving API)]
        GoogleAPI[(Google Sheets API)]
        OpenAI[(OpenAI API)]
    end

    ProductsAPI --> MRLiving
    GSheetGetAPI --> GoogleAPI
    GSheetUpdateAPI --> GoogleAPI
    AIApi --> OpenAI

    %% ============================================================
    %% 樣式定義
    %% ============================================================
    classDef ui fill:#4a90d9,stroke:#2c5282,color:#fff
    classDef hooks fill:#48bb78,stroke:#276749,color:#fff
    classDef services fill:#667eea,stroke:#434190,color:#fff
    classDef store fill:#ed8936,stroke:#c05621,color:#fff
    classDef storeData fill:#f6ad55,stroke:#c05621,color:#000
    classDef api fill:#805ad5,stroke:#553c9a,color:#fff
    classDef external fill:#e2e8f0,stroke:#a0aec0,color:#4a5568

    class CsvDrop,HtmlDrop,EditPage,ProductCard ui
    class useCsv,useFile hooks
    class ProductSvc,ImportSvc,CsvExport,HtmlExport,GSheetSvc services
    class RowsStore store
    class Rows,CodeItems,Results,History storeData
    class ProductsAPI,GSheetGetAPI,GSheetUpdateAPI,AIApi api
    class MRLiving,GoogleAPI,OpenAI external
